version: '3.8'

services:
  # single entry point for all traffic.
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "${NGINX_PORT}:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - app-frontend
      - app-service
    networks:
      - remla-net

  # frontend service
  app-frontend:
    image: ${FRONTEND_IMAGE}
    container_name: app-frontend
    restart: unless-stopped
    networks:
      - remla-net

  # app service
  app-service:
    image: ${APP_IMAGE}
    container_name: app-service
    restart: unless-stopped
    environment:
      - PORT=${APP_PORT}
      - MODEL_SERVICE_URL=model-service
      - MODEL_SERVICE_PORT=${MODEL_PORT}
    networks:
      - remla-net
    secrets:
      - test_secret

  # model service
  model-service:
    image: ${MODEL_IMAGE}
    container_name: model-service
    restart: unless-stopped
    environment:
      - PORT=${MODEL_PORT}
      - RESOURCE_URL=${RESOURCE_URL}
      - MODEL=${MODEL}
      - CV=${CV}
      - MODEL_VERSION=${MODEL_VERSION}
    volumes:
      - model-cache:/models
    networks:
      - remla-net

volumes:
  model-cache:

networks:
  remla-net:

secrets:
  test_secret:
    file: ".secrets/test_secret.txt"
